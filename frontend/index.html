<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOCX Viewer from COS</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #doc-content {
            white-space: pre-wrap;
            font-family: "Courier New", monospace;
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
        }
        input, button {
            margin: 10px 0;
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
<h1>View DOCX from COS</h1>
<input type="text" id="object-key" placeholder="Enter Object Key (e.g., documents/kq/ForTest.docx)" />
<input type="text" id="region" placeholder="Enter Region (e.g., ap-chongqing)" />
<button id="load-docx">Load DOCX</button>
<div id="doc-content">Document content will appear here...</div>

<script src="https://cdn.jsdelivr.net/npm/cos-js-sdk-v5"></script>
<script>
    // Initialize COS SDK with your credentials
    const cos = new COS({
        SecretId: 'AKIDra9XxGPeonZYLyb5i9NQGvMabO0RfgWQ',
        SecretKey: 'rEST0vfEajfNwHRN8iBany31nLgnhT3Q',
    });

    // Event listener for "Load DOCX" button
    document.getElementById('load-docx').addEventListener('click', function() {
        const objectKey = document.getElementById('object-key').value.trim(); // Object path (e.g., documents/kq/ForTest.docx)
        const region = document.getElementById('region').value.trim(); // Region (e.g., ap-chongqing)

        if (!objectKey || !region) {
            alert("Please enter both Object Key and Region.");
            return;
        }

        // Bucket name (lanshan-1338048877) and region (ap-chongqing)
        const bucketName = 'lanshan-1338048877'; // Your Bucket Name

        // Get the DOCX file from COS
        cos.getObject({
            Bucket: bucketName, // Bucket with AppId
            Region: region, // Region
            Key: objectKey, // Object key (file path)
        }, function(err, data) {
            if (err) {
                console.error("Error fetching document from COS:", err);
                alert("Failed to fetch the document.");
                return;
            }

            // Handle the DOCX file and extract its content
            const blob = data.Body;

            // Extract text from DOCX file using JSZip and FileReader
            extractDocxText(blob).then((textContent) => {
                document.getElementById('doc-content').innerText = textContent;
            }).catch((error) => {
                console.error("Error parsing DOCX file", error);
                alert("Failed to parse DOCX file.");
            });
        });
    });

    // Function to extract text from DOCX file
    function extractDocxText(blob) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const arrayBuffer = event.target.result;
                const zip = new JSZip();

                // Load DOCX contents using JSZip
                zip.loadAsync(arrayBuffer).then(function(contents) {
                    // Extract document XML content from DOCX
                    const documentXml = contents.files['word/document.xml']?.async('text');
                    if (!documentXml) {
                        reject(new Error('Document XML not found'));
                        return;
                    }

                    documentXml.then((xml) => {
                        // Parse the XML to extract text
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(xml, 'application/xml');
                        const paragraphs = doc.querySelectorAll('w\\:p, p');
                        let textContent = '';
                        paragraphs.forEach(paragraph => {
                            const runs = paragraph.querySelectorAll('w\\:r, r');
                            runs.forEach(run => {
                                const text = run.querySelector('w\\:t, t');
                                if (text) {
                                    textContent += text.textContent;
                                }
                            });
                            textContent += '\n'; // Newline after each paragraph
                        });
                        resolve(textContent);
                    }).catch(reject);
                }).catch(reject);
            };
            reader.onerror = reject;
            reader.readAsArrayBuffer(blob);
        });
    }
</script>
</body>
</html>
